<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Title</title>
        <link rel="stylesheet" href="../../css/examples.css" />
        <style>
            #indexedDB {
                width: 100%;
                height: 500px;
                position: relative;
            }
        </style>
    </head>
    <body>
        <div id="indexedDB"></div>
        <script src="../../../js/thingorigin.js"></script>
        <script>
            let sceneParams = {
                fileRoot: "/static/three/",
                scene: {
                    webglrenderer: {
                        alpha: true, //是否支持透明
                    },
                    stats: {
                        show: true,
                        mode: 0,
                    },
                    background: {
                        type: "sky",
                        color: {
                            alpha: 0.3, //透明度 取值范围0~1
                            color: "#944",
                        },
                        img: {
                            url: "",
                        },
                        sky: {
                            color: { top: "#86b6f5", line: "#ffffff", bottom: "#999999" },
                            params: {
                                radius: 4000,
                                widthSegments: 32,
                                heightSegments: 15,
                                skyCenter: [0, 0, 0],
                            },
                        },
                    },
                },
                camera: {
                    position: {
                        x: 0,
                        y: 100,
                        z: 500,
                    },
                    near: 0.1,
                    far: 2000,
                },
                lights: [
                    {
                        name: "light1",
                        type: "DirectionalLight",
                        color: undefined,
                        intensity: 1,
                        position: {
                            x: 15,
                            y: 5,
                            z: 5,
                        },
                    },
                    {
                        name: "light2",
                        type: "DirectionalLight",
                        color: undefined,
                        intensity: 1,
                        position: {
                            x: 10,
                            y: 5,
                            z: -10,
                        },
                    },
                    {
                        name: "light3",
                        type: "DirectionalLight",
                        color: undefined,
                        intensity: 1,
                        position: {
                            x: 10,
                            y: -5,
                            z: 5,
                        },
                    },
                    {
                        name: "light4",
                        type: "DirectionalLight",
                        color: undefined,
                        intensity: 1,
                        position: {
                            x: -10,
                            y: -5,
                            z: 5,
                        },
                    },
                ],
                controls: {
                    orbit: {
                        active: true, //是否启用智能相机控制器
                    },
                    raycaster: {
                        active: true, //是否启用鼠标点击控制器
                        events: {
                            click: true,
                            mousemove: true,
                        },
                    },
                    transform: {
                        active: false, //是否启用模型变换控制器
                    },
                    pointerLock: {
                        speed: 1000, //是否启用人工漫游控制器
                    },
                },
                helper: {
                    axes: {
                        active: true,
                        length: 60,
                    },
                    grid: {
                        active: true,
                        size: 150,
                        divisions: 30,
                        centerLineColor: "black",
                        gridColor: "black",
                    },
                },
                effectComposer: {
                    outlinePass: {
                        edgeStrength: 3,
                        edgeGlow: 1, //发光
                        edgeThickness: 1, //光晕粗
                        pulsePeriod: 1, //闪烁
                        usePatternTexture: false, //true
                        visibleEdgeColor: "red", //边缘颜色
                        hiddenEdgeColor: "#190a05",
                    },
                },
                models: [
                    {
                        name: "sphere",
                        position: { x: 0, y: 0, z: 0 },
                        rotation: { x: 0, y: 0, z: 0 },
                        scale: { x: 1, y: 1, z: 1 },
                        objInfo: { objType: "sphere", color: "#f00" },
                    },
                ],
            };
            let mainScene = ThingOrigin.addScene("start", document.getElementById("indexedDB"), sceneParams);

            var db;
            var request = window.indexedDB.open("webDB", 1);
            request.onerror = function (event) {
                console.log("数据库打开报错");
            };
            request.onsuccess = function (event) {
                db = request.result; //event.target.result 也能拿到
                console.log("数据库打开成功");
            };
            request.onupgradeneeded = function (event) {
                db = event.target.result;

                var objectStore;
                if (!db.objectStoreNames.contains("book")) {
                    objectStore = db.createObjectStore("book", {
                        keyPath: "id",
                    });
                    // 定义存储对象的数据项
                    objectStore.createIndex("id", "id", {
                        unique: true,
                    });
                    objectStore.createIndex("name", "name");
                    objectStore.createIndex("model", "model");
                }
                console.log("数据库升级成功");
            };

            function add(book) {
                console.log(db);

                var request1 = db
                    .transaction(["book"], "readwrite") //新建事务，readwrite, readonly(默认), versionchange
                    .objectStore("book") //拿到IDBObjectStore 对象
                    .add({
                        // 插入记录
                        id: book.id,
                        name: book.name,
                        model: book.model,
                    });
                request1.onsuccess = function (event) {
                    console.log("数据写入成功");
                };
                request1.onerror = function (event) {
                    console.log("数据写入失败");
                };
                request1.onabort = function (event) {
                    console.log("事务回滚");
                };
            }

            //步骤一:创建异步对象
            var ajax = new XMLHttpRequest();
            //步骤二:设置请求的url参数,参数一是请求的类型,参数二是请求的url,可以带参数,动态的传递参数starName到服务端
            ajax.open("get", "../../../static/three/xi.gltf");
            //步骤三:发送请求
            ajax.send();
            //步骤四:注册事件 onreadystatechange 状态改变就会调用
            ajax.onreadystatechange = function () {
                if (ajax.readyState == 4 && ajax.status == 200) {
                    let blob = new Blob([ajax.responseText]);
                    console.log(blob);
                    add({ id: 80, name: "xi", model: blob });

                    var transaction = db.transaction("book", "readwrite");
                    var store = transaction.objectStore("book");

                    var dataRequest = store.index("id").get(80);
                    console.log(dataRequest);

                    dataRequest.onsuccess = function (e) {
                        console.log(e.target.result.model);

                        ThingOrigin.model.initFileModel("gltf", e.target.result.model, undefined, true).then((model) => {
                            mainScene.add(model);

                            mainScene.helper.initBox(model.uuid);
                        });
                    };
                }
            };
        </script>
    </body>
</html>
